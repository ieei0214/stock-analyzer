{% extends "base.html" %}

{% block title %}Dashboard - Stock Analyzer{% endblock %}
{% block page_title %}My Watchlist{% endblock %}

{% block content %}
<!-- Add Stock Form -->
<div class="mb-6">
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <form id="add-stock-form" class="flex items-end space-x-4">
            <div class="flex-1 max-w-xs">
                <label for="ticker-input" class="block text-sm font-medium text-gray-700 mb-1">Add Stock to Watchlist</label>
                <input
                    type="text"
                    id="ticker-input"
                    name="ticker"
                    placeholder="Enter ticker (e.g., AAPL)"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary uppercase"
                    maxlength="10"
                    required
                >
            </div>
            <button
                type="submit"
                id="add-stock-btn"
                class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-blue-600 transition-colors font-medium flex items-center space-x-2"
            >
                <span>Add</span>
                <span id="add-spinner" class="spinner hidden"></span>
            </button>
        </form>
        <p id="ticker-error" class="mt-2 text-sm text-red-600 hidden"></p>
    </div>
</div>

<!-- Actions Row -->
<div class="flex justify-between items-center mb-4">
    <div class="text-sm text-gray-500">
        <span id="watchlist-count">0</span> stocks in watchlist
    </div>
    <button
        id="analyze-all-btn"
        class="px-4 py-2 bg-success text-white rounded-lg hover:bg-green-600 transition-colors font-medium flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
        disabled
    >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>
        <span>Analyze All</span>
    </button>
</div>

<!-- Watchlist Table -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
    <div id="watchlist-loading" class="p-8 text-center text-gray-500">
        <div class="spinner mx-auto mb-4"></div>
        <p>Loading watchlist...</p>
    </div>

    <div id="watchlist-empty" class="p-8 text-center hidden">
        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
        </svg>
        <h3 class="text-lg font-medium text-gray-700 mb-2">Your watchlist is empty</h3>
        <p class="text-gray-500 mb-4">Add your first stock to start tracking</p>
    </div>

    <table id="watchlist-table" class="min-w-full divide-y divide-gray-200 hidden">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ticker</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Change</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Recommendation</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Analyzed</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
        </thead>
        <tbody id="watchlist-body" class="bg-white divide-y divide-gray-200">
            <!-- Rows will be inserted here by JavaScript -->
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
    let watchlistData = [];

    // Load watchlist on page load
    async function loadWatchlist() {
        const loading = document.getElementById('watchlist-loading');
        const empty = document.getElementById('watchlist-empty');
        const table = document.getElementById('watchlist-table');
        const body = document.getElementById('watchlist-body');
        const count = document.getElementById('watchlist-count');
        const analyzeAllBtn = document.getElementById('analyze-all-btn');

        try {
            const data = await api('/api/watchlist');
            watchlistData = data;

            loading.classList.add('hidden');
            count.textContent = data.length;

            if (data.length === 0) {
                empty.classList.remove('hidden');
                table.classList.add('hidden');
                analyzeAllBtn.disabled = true;
            } else {
                empty.classList.add('hidden');
                table.classList.remove('hidden');
                analyzeAllBtn.disabled = false;

                body.innerHTML = data.map(item => `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <a href="/analysis/${item.ticker}" class="font-mono font-bold text-primary hover:underline">${item.ticker}</a>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-600">
                            ${item.company_name || '-'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap font-mono">
                            ${item.current_price ? '$' + item.current_price.toFixed(2) : '-'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap font-mono ${getChangeColor(item.price_change_percent)}">
                            ${item.price_change_percent ? (item.price_change_percent >= 0 ? '+' : '') + item.price_change_percent.toFixed(2) + '%' : '-'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${getRecommendationBadge(item.last_recommendation)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${item.last_analyzed ? formatDate(item.last_analyzed) : 'Not analyzed'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <a
                                href="/analysis/${item.ticker}"
                                class="text-gray-500 hover:text-gray-700"
                                title="View Analysis"
                                aria-label="View ${item.ticker} analysis"
                            >
                                <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </a>
                            <button
                                onclick="analyzeStock('${item.ticker}')"
                                class="text-primary hover:text-blue-700"
                                title="Analyze"
                                aria-label="Analyze ${item.ticker}"
                            >
                                <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </button>
                            <button
                                onclick="removeStock('${item.ticker}')"
                                class="text-red-500 hover:text-red-700"
                                title="Remove"
                                aria-label="Remove ${item.ticker} from watchlist"
                            >
                                <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        } catch (error) {
            loading.classList.add('hidden');
            showToast('Failed to load watchlist: ' + error.message, 'error');
        }
    }

    function getChangeColor(change) {
        if (!change) return 'text-gray-400';
        return change >= 0 ? 'text-green-600' : 'text-red-600';
    }

    function getRecommendationBadge(rec) {
        if (!rec) return '<span class="text-gray-400">-</span>';

        const colors = {
            'Buy': 'bg-green-100 text-green-800',
            'Sell': 'bg-red-100 text-red-800',
            'Hold': 'bg-yellow-100 text-yellow-800'
        };

        return `<span class="px-2 py-1 rounded-full text-xs font-medium ${colors[rec] || 'bg-gray-100 text-gray-800'}">${rec}</span>`;
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 1) return 'Just now';
        if (minutes < 60) return `${minutes}m ago`;
        if (hours < 24) return `${hours}h ago`;
        if (days < 7) return `${days}d ago`;
        return date.toLocaleDateString();
    }

    // Add stock form
    document.getElementById('add-stock-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const input = document.getElementById('ticker-input');
        const btn = document.getElementById('add-stock-btn');
        const spinner = document.getElementById('add-spinner');
        const error = document.getElementById('ticker-error');

        const ticker = input.value.trim().toUpperCase();

        if (!ticker) {
            error.textContent = 'Please enter a ticker symbol';
            error.classList.remove('hidden');
            return;
        }

        error.classList.add('hidden');
        btn.disabled = true;
        spinner.classList.remove('hidden');

        try {
            await api('/api/watchlist', {
                method: 'POST',
                body: JSON.stringify({ ticker })
            });

            input.value = '';
            showToast(`${ticker} added to watchlist`, 'success');
            loadWatchlist();
        } catch (err) {
            error.textContent = err.message;
            error.classList.remove('hidden');
            showToast(err.message, 'error');
        } finally {
            btn.disabled = false;
            spinner.classList.add('hidden');
        }
    });

    // Remove stock
    async function removeStock(ticker) {
        const confirmed = await showConfirm(
            'Remove Stock',
            `Are you sure you want to remove ${ticker} from your watchlist?`
        );

        if (!confirmed) return;

        try {
            await api(`/api/watchlist/${ticker}`, { method: 'DELETE' });
            showToast(`${ticker} removed from watchlist`, 'success');
            loadWatchlist();
        } catch (err) {
            showToast(err.message, 'error');
        }
    }

    // Analyze stock
    function analyzeStock(ticker) {
        window.location.href = `/analyze?ticker=${ticker}`;
    }

    // Analyze all
    document.getElementById('analyze-all-btn').addEventListener('click', async () => {
        const confirmed = await showConfirm(
            'Analyze All Stocks',
            `This will analyze all ${watchlistData.length} stocks in your watchlist. Continue?`
        );

        if (!confirmed) return;

        try {
            const result = await api('/api/watchlist/analyze-all', { method: 'POST' });
            showToast(result.message, 'success');
        } catch (err) {
            showToast(err.message, 'error');
        }
    });

    // Clear error on input
    document.getElementById('ticker-input').addEventListener('input', () => {
        document.getElementById('ticker-error').classList.add('hidden');
    });

    // Initial load
    loadWatchlist();
</script>
{% endblock %}
