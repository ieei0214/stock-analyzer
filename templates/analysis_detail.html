{% extends "base.html" %}

{% block title %}{{ ticker }} Analysis - Stock Analyzer{% endblock %}
{% block page_title %}{{ ticker }} Analysis{% endblock %}

{% block content %}
<div id="loading-state" class="text-center py-12">
    <div class="spinner mx-auto mb-4"></div>
    <p class="text-gray-500">Loading analysis...</p>
</div>

<div id="error-state" class="hidden text-center py-12" role="alert" aria-live="polite">
    <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <h3 id="error-title" class="text-lg font-medium text-gray-700 mb-2">No Analysis Found</h3>
    <p id="error-message" class="text-gray-500 mb-4"></p>
    <a href="/analyze?ticker={{ ticker }}" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600">
        Analyze {{ ticker }}
    </a>
</div>

<div id="content" class="hidden">
    <!-- Stock Header -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">
                    <span id="ticker" class="font-mono">{{ ticker }}</span>
                    <span id="company-name" class="text-gray-500 font-normal text-lg ml-2"></span>
                </h2>
                <p class="text-sm text-gray-500">
                    <span id="sector"></span> • <span id="industry"></span>
                </p>
            </div>
            <div class="text-right">
                <p id="current-price" class="text-3xl font-mono font-bold">-</p>
                <p id="price-change" class="text-lg font-mono">-</p>
            </div>
        </div>

        <!-- Latest Recommendation -->
        <div class="bg-gray-50 rounded-lg p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">Latest Recommendation</p>
                    <div class="flex items-center space-x-4 mt-1">
                        <span id="recommendation" class="px-4 py-2 rounded-full text-lg font-bold"></span>
                        <span id="confidence" class="text-gray-600"></span>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-500">Analyzed on</p>
                    <p id="analysis-date" class="font-medium">-</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Reasoning -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Analysis Reasoning</h3>
        <div id="reasoning" class="prose max-w-none text-gray-600"></div>
    </div>

    <!-- Charts Carousel -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Charts</h3>
        <div id="charts-loading" class="text-center py-8 text-gray-500">
            <div class="spinner mx-auto mb-4"></div>
            <p>Loading charts...</p>
        </div>
        <div id="charts-container" class="hidden">
            <!-- Carousel wrapper -->
            <div class="relative">
                <!-- Previous arrow -->
                <button id="chart-prev" class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-4 z-10 w-10 h-10 bg-white rounded-full shadow-lg border border-gray-200 flex items-center justify-center hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" aria-label="Previous chart">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>

                <!-- Charts container (slides) -->
                <div class="overflow-hidden">
                    <div id="charts-slider" class="flex transition-transform duration-300 ease-in-out">
                        <div class="w-full flex-shrink-0 px-4" data-chart="price">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-sm font-medium text-gray-700 mb-3 text-center">Price History with Moving Averages</h4>
                                <img id="price-chart" src="" alt="Price Chart" class="w-full rounded max-h-96 object-contain mx-auto">
                            </div>
                        </div>
                        <div class="w-full flex-shrink-0 px-4" data-chart="rsi">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-sm font-medium text-gray-700 mb-3 text-center">RSI (Relative Strength Index)</h4>
                                <img id="rsi-chart" src="" alt="RSI Chart" class="w-full rounded max-h-96 object-contain mx-auto">
                            </div>
                        </div>
                        <div class="w-full flex-shrink-0 px-4" data-chart="volume">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-sm font-medium text-gray-700 mb-3 text-center">Volume</h4>
                                <img id="volume-chart" src="" alt="Volume Chart" class="w-full rounded max-h-96 object-contain mx-auto">
                            </div>
                        </div>
                        <div class="w-full flex-shrink-0 px-4" data-chart="macd">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-sm font-medium text-gray-700 mb-3 text-center">MACD</h4>
                                <img id="macd-chart" src="" alt="MACD Chart" class="w-full rounded max-h-96 object-contain mx-auto">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Next arrow -->
                <button id="chart-next" class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-4 z-10 w-10 h-10 bg-white rounded-full shadow-lg border border-gray-200 flex items-center justify-center hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" aria-label="Next chart">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
            </div>

            <!-- Carousel indicators -->
            <div class="flex justify-center mt-4 space-x-2">
                <button class="chart-indicator w-3 h-3 rounded-full bg-primary" data-index="0" aria-label="View Price chart"></button>
                <button class="chart-indicator w-3 h-3 rounded-full bg-gray-300" data-index="1" aria-label="View RSI chart"></button>
                <button class="chart-indicator w-3 h-3 rounded-full bg-gray-300" data-index="2" aria-label="View Volume chart"></button>
                <button class="chart-indicator w-3 h-3 rounded-full bg-gray-300" data-index="3" aria-label="View MACD chart"></button>
            </div>

            <!-- Chart name label -->
            <p id="chart-label" class="text-center text-sm text-gray-500 mt-2">1 of 4: Price History</p>
        </div>
        <div id="charts-error" class="hidden text-center py-8 text-gray-500">
            <p>Unable to load charts</p>
        </div>
    </div>

    <!-- Recent News with Sentiment -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Recent News</h3>
        <div id="news-loading" class="text-center py-8 text-gray-500">
            <div class="spinner mx-auto mb-4"></div>
            <p>Loading news...</p>
        </div>
        <div id="news-container" class="space-y-3 hidden">
            <!-- News items will be inserted here -->
        </div>
        <div id="news-empty" class="hidden text-center py-8 text-gray-500">
            <svg class="w-12 h-12 text-gray-300 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
            </svg>
            <p>No recent news available</p>
        </div>
        <div id="news-error" class="hidden text-center py-8 text-gray-500">
            <p>Unable to load news</p>
        </div>
    </div>

    <!-- Analysis History -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Analysis History</h3>
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Recommendation</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Confidence</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Price</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Style</th>
                </tr>
            </thead>
            <tbody id="history-body" class="bg-white divide-y divide-gray-200">
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const ticker = '{{ ticker }}';

    async function loadAnalysis() {
        const loading = document.getElementById('loading-state');
        const error = document.getElementById('error-state');
        const content = document.getElementById('content');

        try {
            // Get latest analysis
            const analysis = await api(`/api/analysis/${ticker}`);

            // Get stock info
            let stock = null;
            try {
                stock = await api(`/api/stock/${ticker}`);
            } catch (e) {
                // Stock may not exist yet
            }

            loading.classList.add('hidden');
            content.classList.remove('hidden');

            // Populate data
            if (stock) {
                document.getElementById('company-name').textContent = stock.company_name || '';
                document.getElementById('sector').textContent = stock.sector || '-';
                document.getElementById('industry').textContent = stock.industry || '-';
            }

            document.getElementById('current-price').textContent = analysis.price_at_analysis
                ? '$' + analysis.price_at_analysis.toFixed(2)
                : '-';

            // Recommendation
            const recEl = document.getElementById('recommendation');
            const colors = {
                'Buy': 'bg-green-100 text-green-800',
                'Sell': 'bg-red-100 text-red-800',
                'Hold': 'bg-yellow-100 text-yellow-800'
            };
            recEl.className = `px-4 py-2 rounded-full text-lg font-bold ${colors[analysis.recommendation] || 'bg-gray-100'}`;
            recEl.textContent = analysis.recommendation;

            document.getElementById('confidence').textContent = `${analysis.confidence_level} Confidence`;
            document.getElementById('analysis-date').textContent = new Date(analysis.analysis_date).toLocaleDateString();

            // Reasoning
            const reasoning = analysis.reasoning || 'No detailed reasoning available.';
            document.getElementById('reasoning').innerHTML = reasoning.replace(/\n/g, '<br>');

            // Load history, charts, and news
            loadHistory();
            loadCharts();
            loadNews();

        } catch (err) {
            loading.classList.add('hidden');
            error.classList.remove('hidden');
            document.getElementById('error-message').textContent = err.message;
        }
    }

    async function loadHistory() {
        try {
            const history = await api(`/api/analysis/${ticker}/history`);
            const tbody = document.getElementById('history-body');

            tbody.innerHTML = history.map(item => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${new Date(item.analysis_date).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${getRecColor(item.recommendation)}">${item.recommendation}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${item.confidence_level}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-mono">${item.price_at_analysis ? '$' + item.price_at_analysis.toFixed(2) : '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${item.analysis_style}</td>
                </tr>
            `).join('');
        } catch (err) {
            console.error('Failed to load history:', err);
        }
    }

    function getRecColor(rec) {
        const colors = {
            'Buy': 'bg-green-100 text-green-800',
            'Sell': 'bg-red-100 text-red-800',
            'Hold': 'bg-yellow-100 text-yellow-800'
        };
        return colors[rec] || 'bg-gray-100 text-gray-800';
    }

    // Chart carousel state
    let currentChartIndex = 0;
    const chartNames = ['Price History', 'RSI', 'Volume', 'MACD'];
    const totalCharts = 4;

    function updateCarousel() {
        const slider = document.getElementById('charts-slider');
        const indicators = document.querySelectorAll('.chart-indicator');
        const label = document.getElementById('chart-label');
        const prevBtn = document.getElementById('chart-prev');
        const nextBtn = document.getElementById('chart-next');

        // Move slider
        slider.style.transform = `translateX(-${currentChartIndex * 100}%)`;

        // Update indicators
        indicators.forEach((indicator, index) => {
            indicator.classList.toggle('bg-primary', index === currentChartIndex);
            indicator.classList.toggle('bg-gray-300', index !== currentChartIndex);
        });

        // Update label
        label.textContent = `${currentChartIndex + 1} of ${totalCharts}: ${chartNames[currentChartIndex]}`;

        // Update button states
        prevBtn.disabled = currentChartIndex === 0;
        nextBtn.disabled = currentChartIndex === totalCharts - 1;
    }

    function setupCarouselControls() {
        const prevBtn = document.getElementById('chart-prev');
        const nextBtn = document.getElementById('chart-next');
        const indicators = document.querySelectorAll('.chart-indicator');

        prevBtn.addEventListener('click', () => {
            if (currentChartIndex > 0) {
                currentChartIndex--;
                updateCarousel();
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentChartIndex < totalCharts - 1) {
                currentChartIndex++;
                updateCarousel();
            }
        });

        // Click on indicators
        indicators.forEach(indicator => {
            indicator.addEventListener('click', () => {
                currentChartIndex = parseInt(indicator.dataset.index);
                updateCarousel();
            });
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' && currentChartIndex > 0) {
                currentChartIndex--;
                updateCarousel();
            } else if (e.key === 'ArrowRight' && currentChartIndex < totalCharts - 1) {
                currentChartIndex++;
                updateCarousel();
            }
        });
    }

    async function loadCharts() {
        const loading = document.getElementById('charts-loading');
        const container = document.getElementById('charts-container');
        const error = document.getElementById('charts-error');

        try {
            // Load all chart types
            const chartTypes = ['price', 'rsi', 'volume', 'macd'];
            const chartPromises = chartTypes.map(type =>
                api(`/api/stock/${ticker}/chart-images?chart_type=${type}`)
            );

            const results = await Promise.all(chartPromises);

            // Set chart images
            document.getElementById('price-chart').src = results[0].image;
            document.getElementById('rsi-chart').src = results[1].image;
            document.getElementById('volume-chart').src = results[2].image;
            document.getElementById('macd-chart').src = results[3].image;

            loading.classList.add('hidden');
            container.classList.remove('hidden');

            // Setup carousel controls after charts are loaded
            setupCarouselControls();
            updateCarousel();
        } catch (err) {
            loading.classList.add('hidden');
            error.classList.remove('hidden');
            console.error('Failed to load charts:', err);
        }
    }

    async function loadNews() {
        const loading = document.getElementById('news-loading');
        const container = document.getElementById('news-container');
        const empty = document.getElementById('news-empty');
        const error = document.getElementById('news-error');

        try {
            const response = await api(`/api/stock/${ticker}/data?data_type=news`);
            const news = response.data || [];

            loading.classList.add('hidden');

            if (news.length === 0) {
                empty.classList.remove('hidden');
                return;
            }

            container.classList.remove('hidden');
            container.innerHTML = news.slice(0, 8).map(item => `
                <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                    <div class="flex-shrink-0">
                        ${getSentimentBadge(item.sentiment)}
                    </div>
                    <div class="flex-1 min-w-0">
                        <a href="${item.link || '#'}" target="_blank" rel="noopener noreferrer"
                           class="text-sm font-medium text-gray-800 hover:text-primary line-clamp-2 ${item.link ? '' : 'pointer-events-none'}">
                            ${escapeHtml(item.title || 'No title')}
                        </a>
                        <div class="flex items-center mt-1 text-xs text-gray-500 space-x-2">
                            <span>${escapeHtml(item.publisher || 'Unknown source')}</span>
                            <span>•</span>
                            <span>${formatNewsDate(item.published_at)}</span>
                        </div>
                    </div>
                    ${item.thumbnail ? `
                        <div class="flex-shrink-0">
                            <img src="${item.thumbnail}" alt="" class="w-16 h-12 object-cover rounded">
                        </div>
                    ` : ''}
                </div>
            `).join('');

        } catch (err) {
            loading.classList.add('hidden');
            error.classList.remove('hidden');
            console.error('Failed to load news:', err);
        }
    }

    function getSentimentBadge(sentiment) {
        const colors = {
            'Positive': 'bg-green-100 text-green-800 border-green-200',
            'Negative': 'bg-red-100 text-red-800 border-red-200',
            'Neutral': 'bg-gray-100 text-gray-600 border-gray-200'
        };
        const icons = {
            'Positive': '↑',
            'Negative': '↓',
            'Neutral': '−'
        };
        const colorClass = colors[sentiment] || colors['Neutral'];
        const icon = icons[sentiment] || icons['Neutral'];
        return `<span class="inline-flex items-center justify-center w-8 h-8 rounded-full text-sm font-bold border ${colorClass}" title="${sentiment} sentiment">${icon}</span>`;
    }

    function formatNewsDate(dateStr) {
        if (!dateStr) return 'Unknown date';
        const date = new Date(dateStr);
        const now = new Date();
        const diff = now - date;
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (hours < 1) return 'Just now';
        if (hours < 24) return `${hours}h ago`;
        if (days < 7) return `${days}d ago`;
        return date.toLocaleDateString();
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    loadAnalysis();
</script>
{% endblock %}
