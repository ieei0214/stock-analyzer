{% extends "base.html" %}

{% block title %}History - Stock Analyzer{% endblock %}
{% block page_title %}Analysis History{% endblock %}

{% block content %}
<!-- Performance Stats -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <p class="text-sm text-gray-500">Total Analyses</p>
        <p id="stat-total" class="text-3xl font-bold text-gray-800">-</p>
    </div>
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <p class="text-sm text-gray-500">Checked</p>
        <p id="stat-checked" class="text-3xl font-bold text-gray-800">-</p>
    </div>
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <p class="text-sm text-gray-500">Success Rate</p>
        <p id="stat-success" class="text-3xl font-bold text-green-600">-</p>
    </div>
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <p class="text-sm text-gray-500">Avg Gain/Loss</p>
        <p id="stat-avg" class="text-3xl font-bold text-gray-800">-</p>
    </div>
</div>

<!-- Filters -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
    <div class="flex flex-wrap items-end gap-4">
        <div>
            <label for="filter-ticker" class="block text-sm font-medium text-gray-700 mb-1">Ticker</label>
            <div class="flex items-center gap-1">
                <select id="filter-ticker" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                    <option value="">All Tickers</option>
                </select>
                <button id="clear-ticker" class="p-2 text-gray-400 hover:text-gray-600 hidden" title="Clear ticker filter" aria-label="Clear ticker filter">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div>
            <label for="filter-start" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
            <div class="flex items-center gap-1">
                <input type="date" id="filter-start" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                <button id="clear-start" class="p-2 text-gray-400 hover:text-gray-600 hidden" title="Clear start date" aria-label="Clear start date">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div>
            <label for="filter-end" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
            <div class="flex items-center gap-1">
                <input type="date" id="filter-end" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                <button id="clear-end" class="p-2 text-gray-400 hover:text-gray-600 hidden" title="Clear end date" aria-label="Clear end date">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        <button id="apply-filters" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600 transition-colors">
            Apply Filters
        </button>
        <button id="clear-filters" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
            Clear All
        </button>
        <div class="flex-1"></div>
        <button id="export-btn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
            <span>Export CSV</span>
        </button>
    </div>
</div>

<!-- History Table -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
    <div id="history-loading" class="p-8 text-center text-gray-500">
        <div class="spinner mx-auto mb-4"></div>
        <p>Loading history...</p>
    </div>

    <div id="history-empty" class="p-8 text-center hidden">
        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h3 class="text-lg font-medium text-gray-700 mb-2">No analysis history</h3>
        <p class="text-gray-500">Analyze some stocks to see them here</p>
    </div>

    <table id="history-table" class="min-w-full divide-y divide-gray-200 hidden">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortBy('analysis_date')">
                    Date <span id="sort-date" class="ml-1"></span>
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortBy('ticker')">
                    Ticker <span id="sort-ticker" class="ml-1"></span>
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Recommendation</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Confidence</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price Then</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price Now</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gain/Loss</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
        </thead>
        <tbody id="history-body" class="bg-white divide-y divide-gray-200">
        </tbody>
    </table>

    <!-- Pagination -->
    <div id="pagination" class="hidden bg-gray-50 px-6 py-3 flex items-center justify-between border-t border-gray-200">
        <div class="text-sm text-gray-500">
            Showing <span id="page-start">0</span> to <span id="page-end">0</span> of <span id="total-count">0</span> results
        </div>
        <div class="flex space-x-2">
            <button id="prev-page" class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
            <span id="page-info" class="px-3 py-1">Page 1</span>
            <button id="next-page" class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let historyData = [];
    let currentPage = 1;
    const pageSize = 20;
    let totalCount = 0;
    let sortField = 'analysis_date';
    let sortOrder = 'desc';

    // URL Parameter Functions
    function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
            ticker: params.get('ticker') || '',
            start_date: params.get('start_date') || '',
            end_date: params.get('end_date') || '',
            page: parseInt(params.get('page')) || 1
        };
    }

    function updateUrlParams() {
        const ticker = document.getElementById('filter-ticker').value;
        const startDate = document.getElementById('filter-start').value;
        const endDate = document.getElementById('filter-end').value;

        const params = new URLSearchParams();
        if (ticker) params.set('ticker', ticker);
        if (startDate) params.set('start_date', startDate);
        if (endDate) params.set('end_date', endDate);
        if (currentPage > 1) params.set('page', currentPage);

        const newUrl = params.toString() ? `${window.location.pathname}?${params.toString()}` : window.location.pathname;
        window.history.replaceState({}, '', newUrl);
    }

    // Update visibility of clear buttons based on filter values
    function updateClearButtons() {
        const tickerValue = document.getElementById('filter-ticker').value;
        const startValue = document.getElementById('filter-start').value;
        const endValue = document.getElementById('filter-end').value;

        document.getElementById('clear-ticker').classList.toggle('hidden', !tickerValue);
        document.getElementById('clear-start').classList.toggle('hidden', !startValue);
        document.getElementById('clear-end').classList.toggle('hidden', !endValue);
    }

    function applyUrlParams() {
        const params = getUrlParams();
        document.getElementById('filter-ticker').value = params.ticker;
        document.getElementById('filter-start').value = params.start_date;
        document.getElementById('filter-end').value = params.end_date;
        currentPage = params.page;
        // Update clear button visibility after applying URL params
        updateClearButtons();
    }

    async function loadStats() {
        try {
            const stats = await api('/api/performance/stats');
            document.getElementById('stat-total').textContent = stats.total_analyses;
            document.getElementById('stat-checked').textContent = stats.total_checked;
            document.getElementById('stat-success').textContent = stats.success_rate.toFixed(1) + '%';
            document.getElementById('stat-avg').textContent = (stats.average_gain_loss >= 0 ? '+' : '') + stats.average_gain_loss.toFixed(2) + '%';
        } catch (err) {
            console.error('Failed to load stats:', err);
        }
    }

    async function loadTickers() {
        try {
            const data = await api('/api/analyses/tickers');
            const select = document.getElementById('filter-ticker');
            data.tickers.forEach(ticker => {
                const option = document.createElement('option');
                option.value = ticker;
                option.textContent = ticker;
                select.appendChild(option);
            });
        } catch (err) {
            console.error('Failed to load tickers:', err);
        }
    }

    async function loadHistory() {
        const loading = document.getElementById('history-loading');
        const empty = document.getElementById('history-empty');
        const table = document.getElementById('history-table');
        const pagination = document.getElementById('pagination');

        loading.classList.remove('hidden');
        table.classList.add('hidden');
        empty.classList.add('hidden');

        try {
            const ticker = document.getElementById('filter-ticker').value;
            const startDate = document.getElementById('filter-start').value;
            const endDate = document.getElementById('filter-end').value;

            let url = `/api/analyses?limit=${pageSize}&offset=${(currentPage - 1) * pageSize}`;
            if (ticker) url += `&ticker=${ticker}`;
            if (startDate) url += `&start_date=${startDate}`;
            if (endDate) url += `&end_date=${endDate}`;

            const data = await api(url);
            historyData = data;

            // Get count
            let countUrl = '/api/analyses/count?';
            if (ticker) countUrl += `&ticker=${ticker}`;
            if (startDate) countUrl += `&start_date=${startDate}`;
            if (endDate) countUrl += `&end_date=${endDate}`;
            const countData = await api(countUrl);
            totalCount = countData.count;

            loading.classList.add('hidden');

            if (data.length === 0) {
                empty.classList.remove('hidden');
                pagination.classList.add('hidden');
            } else {
                table.classList.remove('hidden');
                pagination.classList.remove('hidden');
                renderTable(data);
                updatePagination();
            }

            // Update URL with current filter state
            updateUrlParams();
        } catch (err) {
            loading.classList.add('hidden');
            showToast('Failed to load history: ' + err.message, 'error');
        }
    }

    function renderTable(data) {
        const body = document.getElementById('history-body');
        body.innerHTML = data.map(item => `
            <tr class="hover:bg-gray-50 transition-colors cursor-pointer" onclick="viewAnalysis('${item.ticker}', ${item.id})">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                    ${new Date(item.analysis_date).toLocaleDateString()}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="font-mono font-bold text-primary">${item.ticker}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${getRecommendationBadge(item.recommendation)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    ${getConfidenceBadge(item.confidence_level)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap font-mono">
                    ${item.price_at_analysis ? '$' + item.price_at_analysis.toFixed(2) : '-'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap font-mono">
                    ${item.current_price ? '$' + item.current_price.toFixed(2) : '-'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap font-mono ${getGainLossColor(item.gain_loss_percent)}">
                    ${item.gain_loss_percent !== null ? (item.gain_loss_percent >= 0 ? '+' : '') + item.gain_loss_percent.toFixed(2) + '%' : '-'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button onclick="event.stopPropagation(); checkPerformance(${item.id})" class="text-primary hover:text-blue-700" title="Check Performance">
                        <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function getRecommendationBadge(rec) {
        const colors = {
            'Buy': 'bg-green-100 text-green-800',
            'Sell': 'bg-red-100 text-red-800',
            'Hold': 'bg-yellow-100 text-yellow-800'
        };
        return `<span class="px-2 py-1 rounded-full text-xs font-medium ${colors[rec] || 'bg-gray-100 text-gray-800'}">${rec}</span>`;
    }

    function getConfidenceBadge(conf) {
        const colors = {
            'High': 'text-green-600',
            'Medium': 'text-yellow-600',
            'Low': 'text-red-600'
        };
        return `<span class="${colors[conf] || 'text-gray-600'}">${conf}</span>`;
    }

    function getGainLossColor(val) {
        if (val === null) return 'text-gray-400';
        return val >= 0 ? 'text-green-600' : 'text-red-600';
    }

    function updatePagination() {
        const totalPages = Math.ceil(totalCount / pageSize);
        const start = (currentPage - 1) * pageSize + 1;
        const end = Math.min(currentPage * pageSize, totalCount);

        document.getElementById('page-start').textContent = start;
        document.getElementById('page-end').textContent = end;
        document.getElementById('total-count').textContent = totalCount;
        document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;

        document.getElementById('prev-page').disabled = currentPage === 1;
        document.getElementById('next-page').disabled = currentPage >= totalPages;
    }

    function sortBy(field) {
        if (sortField === field) {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
        } else {
            sortField = field;
            sortOrder = 'desc';
        }
        currentPage = 1;
        loadHistory();
    }

    async function checkPerformance(analysisId) {
        try {
            showToast('Checking performance...', 'info');
            await api(`/api/performance/check/${analysisId}`, { method: 'POST' });
            showToast('Performance checked successfully', 'success');
            loadHistory();
            loadStats();
        } catch (err) {
            showToast(err.message, 'error');
        }
    }

    function viewAnalysis(ticker, analysisId) {
        // Navigate to analysis detail page
        window.location.href = `/analysis/${ticker}`;
    }

    // Event listeners
    document.getElementById('apply-filters').addEventListener('click', () => {
        currentPage = 1;
        loadHistory();
    });

    document.getElementById('clear-filters').addEventListener('click', () => {
        document.getElementById('filter-ticker').value = '';
        document.getElementById('filter-start').value = '';
        document.getElementById('filter-end').value = '';
        updateClearButtons();
        currentPage = 1;
        loadHistory();
    });

    // Individual clear filter buttons
    document.getElementById('clear-ticker').addEventListener('click', () => {
        document.getElementById('filter-ticker').value = '';
        updateClearButtons();
        currentPage = 1;
        loadHistory();
    });

    document.getElementById('clear-start').addEventListener('click', () => {
        document.getElementById('filter-start').value = '';
        updateClearButtons();
        currentPage = 1;
        loadHistory();
    });

    document.getElementById('clear-end').addEventListener('click', () => {
        document.getElementById('filter-end').value = '';
        updateClearButtons();
        currentPage = 1;
        loadHistory();
    });

    // Update clear buttons when filter values change
    document.getElementById('filter-ticker').addEventListener('change', updateClearButtons);
    document.getElementById('filter-start').addEventListener('change', updateClearButtons);
    document.getElementById('filter-end').addEventListener('change', updateClearButtons);

    document.getElementById('prev-page').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            loadHistory();
        }
    });

    document.getElementById('next-page').addEventListener('click', () => {
        currentPage++;
        loadHistory();
    });

    document.getElementById('export-btn').addEventListener('click', async () => {
        // Build export URL with current filters
        const ticker = document.getElementById('filter-ticker').value;
        const startDate = document.getElementById('filter-start').value;
        const endDate = document.getElementById('filter-end').value;

        let url = '/api/analyses/export?';
        const params = [];
        if (ticker) params.push(`ticker=${ticker}`);
        if (startDate) params.push(`start_date=${startDate}`);
        if (endDate) params.push(`end_date=${endDate}`);
        url += params.join('&');

        try {
            showToast('Preparing export...', 'info');

            // Fetch the CSV data
            const response = await fetch(url);

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Export failed');
            }

            // Get the blob
            const blob = await response.blob();

            // Create download link
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;

            // Get filename from Content-Disposition header or use default
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = 'stock_analyses.csv';
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename=([^;]+)/);
                if (filenameMatch) {
                    filename = filenameMatch[1].trim();
                }
            }

            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(downloadUrl);

            showToast('Export complete!', 'success');
        } catch (err) {
            showToast('Export failed: ' + err.message, 'error');
        }
    });

    // Initial load - apply URL params first, then load data
    async function initializePage() {
        await loadTickers();  // Load tickers first so we can set the select value
        applyUrlParams();     // Apply URL params to filter fields
        loadStats();
        loadHistory();
    }

    initializePage();
</script>
{% endblock %}
